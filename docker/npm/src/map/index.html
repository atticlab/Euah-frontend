<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Floor Plan - local coordinate map layers for D3.js</title>
  <script type="text/javascript" src="lib/jquery/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="lib/jquery/jquery-ui-1.8.21.custom.min.js"></script>
  <script type="text/javascript" src="lib/d3/d3.v2.min.js"></script>
  <script type="text/javascript" src="d3.floorplan.min.js"></script>
  <style type="text/css">
    @import url('lib/jquery/jquery-ui.css');
    @import url('d3.floorplan.css');

    body {
      font-size: 14px;
      font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
      margin: 25px auto 20px;
      width: 1818px;
      background: #fcfcfc;
      line-height: 1.45em;
    }

    a {
      color: #555;
    }

    a:hover {
      color: #000;
    }

    ul {
      margin: 0 20px;
      padding: 0;
    }

    div.code {
      border: 1px solid #ccc;
      background: #eee;
      margin: 10px 0 10px 0;
      padding: 10px;
      width: 1818px;
    }
  </style>
</head>
<body>
<p style="text-align: right">Layer Controls &darr;</p>
<div id="demo"></div>
<script src="./node_modules/stellar-sdk/dist/stellar-sdk.min.js"></script>
<script id="demo-code" type="text/javascript">
  //TODO:change
  var Conf = {};
  Conf.horizon = new StellarSdk.Server('http://blockchain.heatchain.tk');
  var start_data = {};

  var xscale = d3.scale.linear()
          .domain([0, 25.0])
          .range([0, 1818]),
      yscale = d3.scale.linear()
          .domain([0, 33.79])
          .range([0, 737]),
      map = d3.floorplan().xScale(xscale).yScale(yscale),
      imagelayer = d3.floorplan.imagelayer(),
      heatmap = d3.floorplan.heatmap(),
      mapdata = {};

  let main_sensor = '';
  let main_sensor_value = null;

  let wc_sensor = '';
  let wc_sensor_value = null;

  let blackroom_sensor = '';
  let blackroom_sensor_value = null;

  Promise.resolve()
      .then(() => {

      main_sensor = localStorage.getItem('main_sensor');

      while (!main_sensor || main_sensor.length != 56) {
          main_sensor = prompt('Main room sensor account id', '');
      }

      localStorage.setItem('main_sensor', main_sensor);

      return Conf.horizon.payments()
          .forAccount(main_sensor)
          .limit(10)
          .order('desc')
          .call()
  })
      .catch((err) => {
        console.error(err);
        console.log('normal');
      })
      .then(function (result) {

      if (result && result.records && result.records.length > 0) {
          result.records.map(payment => {
              if (main_sensor_value !== null && payment.from == main_sensor ) {
                  main_sensor_value = payment.amount;
              }

          })
      }

      if (main_sensor_value == null) {
          main_sensor_value = 0;
      }

      wc_sensor = localStorage.getItem('wc_sensor');

      while (!wc_sensor || wc_sensor.length != 56) {
          wc_sensor = prompt('WC room sensor account id', '');
      }

      localStorage.setItem('wc_sensor', wc_sensor);

      return Conf.horizon.payments()
          .forAccount(wc_sensor)
          .limit(10)
          .order('desc')
          .call()
  }).catch((err) => {
      console.error(err);
      console.log('normal');
  })
  .then(function (result) {
      if (result && result.records && result.records.length > 0) {
          result.records.map(payment => {
              if (wc_sensor_value !== null && payment.from == wc_sensor ) {
                  wc_sensor_value = payment.amount;
              }

          })
      }

      if (wc_sensor_value == null) {
          wc_sensor_value = 0;
      }

      blackroom_sensor = localStorage.getItem('blackroom_sensor');

      while (!blackroom_sensor || blackroom_sensor.length != 56) {
          blackroom_sensor = prompt('Black room sensor account id', '');
      }

      localStorage.setItem('blackroom_sensor', blackroom_sensor);
      return Conf.horizon.payments()
          .forAccount(blackroom_sensor)
          .limit(10)
          .order('desc')
          .call()

  }).catch((err) => {
      console.error(err);
      console.log('normal');
  })
  .then(function (result) {
      if (result && result.records && result.records.length > 0) {
          result.records.map(payment => {
              if (blackroom_sensor_value !== null && payment.from == blackroom_sensor ) {
                  blackroom_sensor_value = payment.amount;
              }

          })
      }

      if (blackroom_sensor_value == null) {
          blackroom_sensor_value = 0;
      }

      start_data = {
          "heatmap": {
              "binSize": 1,
              "units": "\u00B0C",
              "map": [
                  {
                      "account_id": main_sensor,
                      "value": main_sensor_value,
                      "points": [
                          {
                              "x": 6.5,
                              "y": 1
                          },
                          {
                              "x": 12,
                              "y": 1
                          },
                          {
                              "x": 12,
                              "y": 13.5
                          },
                          {
                              "x": 6.5,
                              "y": 13.5
                          }
                      ]
                  },{
                      "account_id": wc_sensor,
                      "value": wc_sensor_value,
                      "points": [
                          {
                              "x": 0.6,
                              "y": 20
                          },
                          {
                              "x": 3.25,
                              "y": 20
                          },
                          {
                              "x": 3.25,
                              "y": 27.0
                          },
                          {
                              "x": 0.6,
                              "y": 27.0
                          }
                      ]
                  },{
                      "account_id": blackroom_sensor,
                      "value": blackroom_sensor_value,
                      "points": [
                          {
                              "x": 0.6,
                              "y": 0.2
                          },
                          {
                              "x": 3.7,
                              "y": 0.2
                          },
                          {
                              "x": 3.7,
                              "y": 10.2
                          },
                          {
                              "x": 0.6,
                              "y": 10.2
                          }
                      ]
                  }
              ]
          }
      };

      mapdata[imagelayer.id()] = [{
          url: 'hachaton_plan.jpg',
          x: 0,
          y: 0,
          height: 33.79,
          width: 25.0
      }];

      map.addLayer(imagelayer)
          .addLayer(heatmap)
      ;

      localStorage.setItem('data', JSON.stringify(start_data));
      mapdata[heatmap.id()] = start_data.heatmap;

      d3.select("#demo").append("svg")
          .attr("height", 737).attr("width", 1818)
          .datum(mapdata)
          .call(map)
      ;

  })

  //set stream for balances update
  Conf.horizon.payments()
      .cursor('now')
      .stream({
        onmessage: function (payment) {
          console.log(payment);
          let data = JSON.parse(localStorage.getItem('data'));

          data.heatmap.map.map(sensor => {
            if (sensor.account_id == payment.from) {

              sensor.value = payment.amount;
              localStorage.setItem('data', JSON.stringify(data));

              mapdata[heatmap.id()] = data.heatmap;

              d3.select("#demo")
                  .datum(mapdata)
                  .call(map)
            }
          });
        },
        onerror: function () {
          console.log('Cannot get payment from stream');
        }
      });
</script>
</body>
</html>
